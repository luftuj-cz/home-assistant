#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

set -euo pipefail

bashio::log.info "Starting the Luftuj backend service..."

PORT=$(bashio::config 'web_port')
if [ -z "${PORT}" ] || [ "${PORT}" = "null" ]; then
  PORT=8099
fi

function handle_error() {
    bashio::log.error "An error occurred while starting the Luftuj backend service."
    bashio::log.error "Error on line $1: Command '$2' exited with status $3"
    exit 1
}
trap 'handle_error $LINENO "$BASH_COMMAND" $?' ERR

cd /usr/src/app || bashio::exit.nok "Could not change directory to /usr/src/app"

# Export Home Assistant API details
export HA_BASE_URL="http://supervisor/core"
export SUPERVISOR_TOKEN="${SUPERVISOR_TOKEN}"

# Export logging configuration
export LOG_LEVEL=$(bashio::config 'log_level')

# Export MQTT configuration if available
if bashio::services.available "mqtt"; then
    bashio::log.info "MQTT service found, exporting configuration..."
    export MQTT_HOST=$(bashio::services "mqtt" "host")
    export MQTT_PORT=$(bashio::services "mqtt" "port")
    export MQTT_USER=$(bashio::services "mqtt" "username")
    export MQTT_PASSWORD=$(bashio::services "mqtt" "password")
else
    bashio::log.info "MQTT service not found, relying on manual configuration..."
fi

bashio::log.info "Starting server on port ${PORT}..."
PORT="${PORT}" exec bun run src/server.ts || bashio::exit.nok "Failed to start the server"
